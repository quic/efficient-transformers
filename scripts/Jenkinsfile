pipeline {
   agent {
       node {
           label 'qeff_node'
       }
   }
   options {
        disableConcurrentBuilds()
    }

   stages {
       stage('Install QEfficient') {
           steps {
               sh '''
                   . ~/.bashrc
                   sudo docker run --privileged -dit --name ${BUILD_TAG} -e HF_TOKEN=${HF_TOKEN} -v ./:/efficient-transformers -v ${HF_PATH}:${DOCKER_HF_PATH} ${DOCKER_LATEST}:master_latest
                   sudo docker exec ${BUILD_TAG} bash -c "
                   cd /efficient-transformers &&
                   apt update &&
                   apt install -y python3.10-venv &&
                   python3.10 -m venv preflight_qeff &&
                   . preflight_qeff/bin/activate &&
                   pip install --upgrade pip setuptools &&
                   pip install .[test] &&
                   pip install junitparser pytest-xdist &&
                   pip install librosa==0.10.2 soundfile==0.13.1 && #packages needed to load example for whisper testing
                   pip install --extra-index-url https://download.pytorch.org/whl/cpu timm==1.0.14 torchvision==0.22.0+cpu einops==0.8.1 && #packages to load VLMs
                   rm -rf QEfficient"
               '''
           }
       }
       stage('HL APIs Tests') {
           parallel {
               stage('Model Export & ONNX Tests') {
                   steps {
                       timeout(time: 40, unit: 'MINUTES') {
                           sh '''
                           sudo docker exec ${BUILD_TAG} bash -c "
                           cd /efficient-transformers &&
                           . preflight_qeff/bin/activate &&
                           mkdir -p $PWD/Non_cli_qaic &&
                           export TOKENIZERS_PARALLELISM=false &&
                           export QEFF_HOME=$PWD/Non_cli_qaic &&
                           pytest tests -m '(not cli) and (not on_qaic) and (not finetune)' --ignore tests/vllm --ignore tests/transformers/models/image_text_to_text -n 4 --junitxml=tests/tests_log1.xml --durations=10 &&
                           junitparser merge tests/tests_log1.xml tests/tests_log.xml &&
                           deactivate"
                           '''
                       }
                   }
               }
               stage('QAIC LLM Tests') {
                   steps {
                       timeout(time: 120, unit: 'MINUTES') {
                           sh '''
                           sudo docker exec ${BUILD_TAG} bash -c "
                           cd /efficient-transformers &&
                           . preflight_qeff/bin/activate &&
                           mkdir -p $PWD/Non_qaic_llm &&
                           export TOKENIZERS_PARALLELISM=false &&
                           export QEFF_HOME=$PWD/Non_qaic_llm &&
                           pytest tests -m '(not cli) and (on_qaic) and (llm_model) and (not nightly) and (not multimodal) and (not qnn) and (not finetune) and (not diffusion_models)' --ignore tests/vllm --junitxml=tests/tests_log2.xml --durations=10 &&
                           junitparser merge tests/tests_log2.xml tests/tests_log.xml &&
                           deactivate"
                           '''
                       }
                   }
               }
               stage('QAIC Feature Tests') {
                   steps {
                       timeout(time: 80, unit: 'MINUTES') {
                           sh '''
                           sudo docker exec ${BUILD_TAG} bash -c "
                           cd /efficient-transformers &&
                           . preflight_qeff/bin/activate &&
                           mkdir -p $PWD/Non_qaic_feature &&
                           export TOKENIZERS_PARALLELISM=false &&
                           export QEFF_HOME=$PWD/Non_qaic_feature &&
                           pytest tests -m '(not cli) and (on_qaic) and (feature) and (not nightly) and (not multimodal) and (not qnn) and (not finetune) and (not diffusion_models)' --ignore tests/vllm --junitxml=tests/tests_log2_feature.xml --durations=10 &&
                           junitparser merge tests/tests_log2_feature.xml tests/tests_log.xml &&
                           deactivate"
                           '''
                       }
                   }
               }
           }
       }
        stage('QAIC MultiModal Tests') {
                   steps {
                       timeout(time: 120, unit: 'MINUTES') {
                           sh '''
                           sudo docker exec ${BUILD_TAG} bash -c "
                           cd /efficient-transformers &&
                           . preflight_qeff/bin/activate &&
                           mkdir -p $PWD/Non_cli_qaic_multimodal &&
                           export TOKENIZERS_PARALLELISM=false &&
                           export QEFF_HOME=$PWD/Non_cli_qaic_multimodal &&
                           pytest tests -m '(not cli) and (on_qaic) and (multimodal) and (not qnn) and (not finetune) and (not diffusion_models)' --ignore tests/vllm --junitxml=tests/tests_log6.xml --durations=10 &&
                           junitparser merge tests/tests_log6.xml tests/tests_log.xml &&
                           deactivate"
                           '''
                       }
                   }
        }
        stage('QAIC Diffusion Models Tests') {
            steps {
                timeout(time: 120, unit: 'MINUTES') {
                    sh '''
                    sudo docker exec ${BUILD_TAG} bash -c "
                    cd /efficient-transformers &&
                    . preflight_qeff/bin/activate &&
                    mkdir -p $PWD/Non_cli_qaic_diffusion &&
                    export TOKENIZERS_PARALLELISM=false &&
                    export QEFF_HOME=$PWD/Non_cli_qaic_diffusion &&
                    export HF_HUB_CACHE=/huggingface_hub &&
                    pytest tests -m '(not cli) and (on_qaic) and (diffusion_models) and (not wan) and (not qnn) and (not finetune)' --ignore tests/vllm --junitxml=tests/tests_log_diffusion.xml --durations=10 &&
                    junitparser merge tests/tests_log_diffusion.xml tests/tests_log.xml &&
                    deactivate"
                    '''
                }
            }
        }
       stage('CLI Inference Tests') {
                   steps {
                       timeout(time: 120, unit: 'MINUTES') {
                           sh '''
                           sudo docker exec ${BUILD_TAG} bash -c "
                    	   #source /qnn_sdk/bin/envsetup.sh &&
                      	   #source /qnn_sdk/bin/envcheck -c &&
                           cd /efficient-transformers &&
                           . preflight_qeff/bin/activate &&
                           mkdir -p $PWD/cli &&
                           export TOKENIZERS_PARALLELISM=false &&
                           export QEFF_HOME=$PWD/cli &&
                           pytest tests -m '(cli and not qnn) and (not finetune)' --ignore tests/vllm --junitxml=tests/tests_log3.xml --durations=10 &&
                           junitparser merge tests/tests_log3.xml tests/tests_log.xml &&
                           deactivate"
                           '''
                       }
                   }
        }
        // stage('QNN CLI Tests') {
        //     steps {
        //         timeout(time: 30, unit: 'MINUTES') {
        //             sh '''
        //             sudo docker exec ${BUILD_TAG} bash -c "
        //             source /qnn_sdk/bin/envsetup.sh &&
        //             source /qnn_sdk/bin/envcheck -c &&
        //             cd /efficient-transformers &&
        //             . preflight_qeff/bin/activate &&
        //             mkdir -p $PWD/Qnn_cli &&
        //             export TOKENIZERS_PARALLELISM=false &&
        //             export QEFF_HOME=$PWD/Qnn_cli &&
        //             pytest tests -m '(cli and qnn) and (not finetune)' --ignore tests/vllm --junitxml=tests/tests_log4.xml &&
        //             junitparser merge tests/tests_log4.xml tests/tests_log.xml &&
        //             deactivate"
        //             '''
        //         }
        //     }
        // }
        // stage('QNN Non-CLI Tests') {
        //     steps {
        //         timeout(time: 200, unit: 'MINUTES') {
        //             sh '''
        //             sudo docker exec ${BUILD_TAG} bash -c "
        //             source /qnn_sdk/bin/envsetup.sh &&
        //             source /qnn_sdk/bin/envcheck -c &&
        //             cd /efficient-transformers &&
        //             . preflight_qeff/bin/activate &&
        //             mkdir -p $PWD/Qnn_non_cli &&
        //             export TOKENIZERS_PARALLELISM=false &&
        //             export QEFF_HOME=$PWD/Qnn_non_cli &&
        //             pytest tests -m '(not cli) and (qnn) and (not nightly) and (on_qaic) and (not multimodal) and (not finetune)' --ignore tests/vllm --junitxml=tests/tests_log5.xml &&
        //             junitparser merge tests/tests_log5.xml tests/tests_log.xml &&
        //             deactivate"
        //             '''
        //         }
        //     }
        // }
        // stage('QNN MultiModal Tests') {
        //     steps {
        //         timeout(time: 60, unit: 'MINUTES') {
        //             sh '''
        //             sudo docker exec ${BUILD_TAG} bash -c "
        //             source /qnn_sdk/bin/envsetup.sh &&
        //             source /qnn_sdk/bin/envcheck -c &&
        //             cd /efficient-transformers &&
        //             . preflight_qeff/bin/activate &&
        //             mkdir -p $PWD/Non_cli_qnn_multimodal &&
        //             export TOKENIZERS_PARALLELISM=false &&
        //             export QEFF_HOME=$PWD/Non_cli_qnn_multimodal &&
        //             pytest tests -m '(not cli) and (on_qaic) and (multimodal) and (qnn)' --ignore tests/vllm --junitxml=tests/tests_log7.xml &&
        //             junitparser merge tests/tests_log7.xml tests/tests_log.xml &&
        //             deactivate"
        //             '''
        //         }
        //     }
        // }
        stage('Finetune CLI Tests') {
            steps {
                timeout(time: 20, unit: 'MINUTES') {
                    sh '''
                    sudo docker exec ${BUILD_TAG} bash -c "
                    cd /efficient-transformers &&
                    . preflight_qeff/bin/activate &&
                    pip install /opt/qti-aic/integrations/torch_qaic/py310/torch_qaic-0.1.0-cp310-cp310-linux_x86_64.whl &&
                    pip install torch==2.9.0 torchvision==0.24.0 torchaudio==2.9.0 --index-url https://download.pytorch.org/whl/cpu &&
                    mkdir -p $PWD/cli_qaic_finetuning &&
                    export TOKENIZERS_PARALLELISM=false &&
                    export QEFF_HOME=$PWD/cli_qaic_finetuning &&
                    pytest tests -m '(cli) and (on_qaic) and (not qnn) and (not multimodal) and (finetune)' --ignore tests/vllm --junitxml=tests/tests_log_finetune.xml --durations=10 &&
                    junitparser merge tests/tests_log_finetune.xml tests/tests_log.xml &&
                    deactivate"
                    '''
                }
            }
        }
    }

   post {
        // success {
        //     // Trigger downstream job only if this pipeline succeeds
        //     build job: 'qefficient_vllm_upstream',
        //         parameters: [
        //             string(name: 'NAME', value: "${BUILD_TAG}"),
        //             string(name: 'QEFF_WORKSPACE', value: "${env.WORKSPACE}")
        //         ],
        //         wait: false
        // }
        always {
            script {
                try {
                    sh '''
                    sudo chown -R ubuntu .
                    '''
                } catch (error) {
                    echo "Failed to change ownership: ${error}"
                }
            }
            script {
                try {
                    junit testResults: 'tests/tests_log.xml', allowEmptyResults: true
                } catch (error) {
                    echo "No test results file found or parsing failed: ${error}"
                }
            }
            script {
                try {
                    sh '''
                    sudo docker rm -f ${BUILD_TAG}
                    '''
                } catch (error) {
                    echo "Failed to delete container ${BUILD_TAG}: ${error}"
                }
            }
            echo 'Cleaning Workspace'
            deleteDir()
        }
        // unsuccessful {
        //     script {
        //         try {
        //             sh '''
        //             sudo docker rm -f ${BUILD_TAG}
        //             '''
        //         } catch (error) {
        //             echo "Failed to delete container ${BUILD_TAG}: ${error}"
        //         }
        //     }
        //     echo 'Cleaning Workspace'
        //     deleteDir()
        // }
    }
}
